Main code. Edit with care.
